<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Automating Klipper MCU Updates - </title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Automating Klipper MCU Updates | Gadget Angel Voron Documentation</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="Automating Klipper MCU Updates" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Voron Official and Community Documentation" /> <meta property="og:description" content="Voron Official and Community Documentation" /> <link rel="canonical" href="http://localhost:4000/community/howto/drachenkatze/automating_klipper_mcu_updates.html" /> <meta property="og:url" content="http://localhost:4000/community/howto/drachenkatze/automating_klipper_mcu_updates.html" /> <meta property="og:site_name" content="Gadget Angel Voron Documentation" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Automating Klipper MCU Updates" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Voron Official and Community Documentation","headline":"Automating Klipper MCU Updates","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/images/voron_design_logo.png"}},"url":"http://localhost:4000/community/howto/drachenkatze/automating_klipper_mcu_updates.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="http://localhost:4000/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="http://localhost:4000/" class="nav-list-link">Voron Documentation</a></li><li class="nav-list-item"><a href="http://localhost:4000/about.html" class="nav-list-link">About Voron</a></li><li class="nav-list-item"><a href="http://localhost:4000/hardware.html" class="nav-list-link">Choosing a Printer / Extruder</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/sourcing.html" class="nav-list-link">Sourcing Information</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/materials.html" class="nav-list-link">Materials Selection</a></li><li class="nav-list-item "><a href="http://localhost:4000/sourcing_faq.html" class="nav-list-link">Sourcing / Buying FAQ</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/build/" class="nav-list-link">The Build</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/build/mechanical/" class="nav-list-link">Mechanical Assembly</a></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/build/electrical/" class="nav-list-link">Electrical Wiring</a><ul class="nav-list"></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/build/software/" class="nav-list-link">Software Installation</a><ul class="nav-list"><li class="nav-list-item "> <a href="http://localhost:4000/build/software/installing_mainsail.html" class="nav-list-link">Installing Mainsail</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/build/software/installing_fluidd.html" class="nav-list-link">Installing Fluidd</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/build/software/installing_octoprint.html" class="nav-list-link">Installing Octoprint</a> </li></ul></li><li class="nav-list-item "><a href="http://localhost:4000/build/software/configuration.html" class="nav-list-link">Software Configuration</a></li><li class="nav-list-item "><a href="http://localhost:4000/build/startup/" class="nav-list-link">Initial Startup</a></li><li class="nav-list-item "><a href="http://localhost:4000/build/slicer/" class="nav-list-link">Slicer Setup</a></li><li class="nav-list-item "><a href="http://localhost:4000/build/slicer/first_print.html" class="nav-list-link">First Print</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/tuning/" class="nav-list-link">Tuning Guides</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/tuning/secondary_printer_tuning.html" class="nav-list-link">Secondary Printer Tuning</a></li><li class="nav-list-item "><a href="http://localhost:4000/tuning/filament_tuning.html" class="nav-list-link">Filament Tuning</a></li></ul></li><li class="nav-list-item"><a href="http://localhost:4000/maintenance.html" class="nav-list-link">Maintenance Guide</a></li><li class="nav-list-item"><a href="http://localhost:4000/history.html" class="nav-list-link">Voron History</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/community/" class="nav-list-link">Community Documentation</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/community/howto/" class="nav-list-link">How-To's</a></li><li class="nav-list-item "><a href="http://localhost:4000/community/troubleshooting/" class="nav-list-link">Troubleshooting</a></li><li class="nav-list-item "><a href="http://localhost:4000/community/electronics/" class="nav-list-link">Alternate Electronics</a></li><li class="nav-list-item "><a href="http://localhost:4000/community/macros/" class="nav-list-link">Custom Macros</a></li><li class="nav-list-item "><a href="http://localhost:4000/community/video_guides.html" class="nav-list-link">Video Guides</a></li><li class="nav-list-item "><a href="http://localhost:4000/community/resources.html" class="nav-list-link">Other Resources</a></li><li class="nav-list-item "><a href="http://localhost:4000/community/support/submission_information.html" class="nav-list-link">Community Submission Information</a></li><li class="nav-list-item "><a href="http://localhost:4000/community/support/pull_request_guide.html" class="nav-list-link">Pull Request Guide</a></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search " aria-label="Search " autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/GadgetAngel/GA-Voron-Documentation" class="site-button" > Voron Documentation on GitHub </a> </li> <li class="aux-nav-list-item"> <a href="https://gadgetangel.org" class="site-button" > VoronDesign Home </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 id="automating-klipper-mcu-updates"> <a href="#automating-klipper-mcu-updates" class="anchor-heading" aria-labelledby="automating-klipper-mcu-updates"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Automating Klipper MCU Updates </h1> <p>This document describes a method to make updating your MCUs to the latest Klipper version easy, especially with multiple boards.</p> <h2 id="terminology"> <a href="#terminology" class="anchor-heading" aria-labelledby="terminology"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Terminology </h2> <ul> <li><code class="language-plaintext highlighter-rouge">Host System</code>: The system where you run the host part of Klipper on, usually on a Raspberry Pi.</li> <li><code class="language-plaintext highlighter-rouge">MCU</code>: The board(s) where your microcontroller unit (<code class="language-plaintext highlighter-rouge">MCU</code>) runs on, like the SKR, Octopus or Spider, but also the RPI itself if you are using SPI for the ADXL345 accelerometer.</li> </ul> <h2 id="prerequisites"> <a href="#prerequisites" class="anchor-heading" aria-labelledby="prerequisites"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prerequisites </h2> <ul> <li>Basic knowledge on how to update Klipper on the command line via SSH</li> <li>A board which supports <a href="https://www.klipper3d.org/SDCard_Updates.html">flashing the firmware</a> via an SD-Card, which almost all modern 32-bit controller boards support.</li> </ul> <h2 id="introduction"> <a href="#introduction" class="anchor-heading" aria-labelledby="introduction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction </h2> <p>Whenever you update Klipper on your host system, you should also update Klipper on all your MCUs. This is because Klipper on your host system and Klipper on your MCUs need to use the same communication protocol. If one of them is out of date, you get an error like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mcu 'mcu': Command format mismatch: endstop_home oid=%c clock=%u sample_ticks=%u sample_count=%c rest_ticks=%u
pin_value=%c trsync_oid=%c trigger_reason=%c vs endstop_home oid=%c clock=%u sample_ticks=%u sample_count=%c
rest_ticks=%u pin_value=%c

This type of error is frequently caused by running an older
version of the firmware on the micro-controller (fix by
recompiling and flashing the firmware).
</code></pre></div></div> <p>However, MCU updates are often skipped because:</p> <ul> <li>Updating all MCUs is tedious, especially with multiple controller boards</li> <li>Error-prone because if different boards are used, <code class="language-plaintext highlighter-rouge">make menuconfig</code> needs to be called multiple times</li> <li>Updates are technically only necessary if the communication protocol has changed, often causing the updates to feel “unnecessary”</li> </ul> <h2 id="menuconfig-theory"> <a href="#menuconfig-theory" class="anchor-heading" aria-labelledby="menuconfig-theory"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> menuconfig Theory </h2> <p>Klipper uses the <a href="https://en.wikipedia.org/wiki/Menuconfig">menuconfig</a> system, which was originally developed to make configuring the <a href="https://en.wikipedia.org/wiki/Linux_kernel">Linux Kernel</a> easier. The <code class="language-plaintext highlighter-rouge">menuconfig</code> system is a more user-friendly way of setting options in the configuration file (usually called <code class="language-plaintext highlighter-rouge">.config</code>).</p> <p>Because the name of the configuration file does not change inbetween invocations of <code class="language-plaintext highlighter-rouge">make menuconfig</code>, settings done for one MCU board will overwrite the previous settings in the default <code class="language-plaintext highlighter-rouge">.config</code> file.</p> <p>Fortunately, the <code class="language-plaintext highlighter-rouge">menuconfig</code> infrastructure supports custom configuration files, so we can easily add one configuration file for each of our MCUs. This is achieved by passing <code class="language-plaintext highlighter-rouge">KCONFIG_CONFIG=name</code> to the script, where <code class="language-plaintext highlighter-rouge">name</code> is the desired name of the configuration file instead of <code class="language-plaintext highlighter-rouge">.config</code>.</p> <p>Note that the <code class="language-plaintext highlighter-rouge">.config</code> file is often not visible because files starting with a dot are treated as hidden files by Linux/Unix systems. To view the contents of this file, simply type <code class="language-plaintext highlighter-rouge">cat .config</code> in your Klipper directory or use <code class="language-plaintext highlighter-rouge">ls -all</code> to view all files in the directory.</p> <p>An example would be:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make clean KCONFIG_CONFIG=config.spider
make menuconfig KCONFIG_CONFIG=config.spider
make KCONFIG_CONFIG=config.spider
</code></pre></div></div> <p>All the settings would now be stored in the file <code class="language-plaintext highlighter-rouge">config.spider</code>. If you skip the <code class="language-plaintext highlighter-rouge">KCONFIG_CONFIG</code> parameter, the system would revert to the <code class="language-plaintext highlighter-rouge">.config</code> filename.</p> <h2 id="flash-sdcard-theory"> <a href="#flash-sdcard-theory" class="anchor-heading" aria-labelledby="flash-sdcard-theory"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> flash-sdcard Theory </h2> <p>Usually you would copy the firmware file onto your SD-Card and then restart your board(s), then waiting for the board(s) to flash the new firmware for you. Thanks to Klipper’s <a href="https://www.klipper3d.org/SDCard_Updates.html">flash-sdcard.sh</a> script, this can be automated.</p> <p>In a nutshell, this script places the new firmware file on the card, restarts the board, waits for the new firmware to be flashed, and then verifies the new firmware. This can be done with a single command after the firmware is compiled:</p> <p><code class="language-plaintext highlighter-rouge">./scripts/flash-sdcard.sh /dev/ttyACM0 btt-skr-v1.3</code></p> <p>Note that the serial path and the board parameters need to be adjusted for your particular board, please refer to the <a href="https://www.klipper3d.org/SDCard_Updates.html">flash-sdcard.sh Documentation</a></p> <h2 id="full-example"> <a href="#full-example" class="anchor-heading" aria-labelledby="full-example"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Full Example </h2> <p>Here is a simple example for my v1.8 where I have a Fysetc Spider and an RPI MCU.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo service klipper stop
cd ~/klipper
git pull

make clean KCONFIG_CONFIG=config.spider
make menuconfig KCONFIG_CONFIG=config.spider
make KCONFIG_CONFIG=config.spider
./scripts/flash-sdcard.sh /dev/ttyAMA0 fysetc-spider-v1

make clean KCONFIG_CONFIG=config.rpi
make menuconfig KCONFIG_CONFIG=config.rpi
make flash KCONFIG_CONFIG=config.rpi

sudo service klipper start
</code></pre></div></div> <p>You could simply place all the required commands in a text file <code class="language-plaintext highlighter-rouge">update-all.sh</code> within the Klipper directory, and then run all the above commands by using one single command: <code class="language-plaintext highlighter-rouge">bash update-all.sh</code>.</p> <p>Note that you still need to watch for errors during the build process!</p> <h2 id="elegant-example"> <a href="#elegant-example" class="anchor-heading" aria-labelledby="elegant-example"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Elegant Example </h2> <p>This example adds an input prompt to hit <code class="language-plaintext highlighter-rouge">[Enter]</code> after each step, so it’s easier to spot errors during the previous step.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo service klipper stop
cd ~/klipper
git pull

make clean KCONFIG_CONFIG=config.spider
make menuconfig KCONFIG_CONFIG=config.spider
make KCONFIG_CONFIG=config.spider
read -p "Spider firmware built, please check above for any errors. Press [Enter] to continue flashing, or [Ctrl+C] to abort"

./scripts/flash-sdcard.sh /dev/ttyAMA0 fysetc-spider-v1
read -p "Spider firmware flashed, please check above for any errors. Press [Enter] to continue, or [Ctrl+C] to abort"

make clean KCONFIG_CONFIG=config.rpi
make menuconfig KCONFIG_CONFIG=config.rpi

make KCONFIG_CONFIG=config.rpi
read -p "RPi firmware built, please check above for any errors. Press [Enter] to continue flashing, or [Ctrl+C] to abort"
make flash KCONFIG_CONFIG=config.rpi

sudo service klipper start
</code></pre></div></div> <h2 id="faq"> <a href="#faq" class="anchor-heading" aria-labelledby="faq"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> FAQ </h2> <h3 id="can-i-just-skip-the-menuconfig-line"> <a href="#can-i-just-skip-the-menuconfig-line" class="anchor-heading" aria-labelledby="can-i-just-skip-the-menuconfig-line"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Can I just skip the menuconfig line? </h3> <p>You could, but if Klipper decides to add another configuration option during an update, the new option would be missing from the config file and the build process would complain. Running <code class="language-plaintext highlighter-rouge">make menuconfig</code> ensures that the new option is added with the defaults.</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
